! Thi program is to compute the solution of INS Equation for HIT problem
! in a periodic box
program main
  !  use, intrinsic :: iso_c_binding
  use fft_module
  !implicit none
  !include 'fftw3.f03'

  ! Mesh resolution
  integer, parameter :: n=64, nx=n, ny=n, nz=n
  integer, parameter :: nxnynz=nx*ny*nz
  integer, parameter :: nhp1=n/2+1
  integer, parameter :: ncube=n**3
  character(len=16) :: filename
  
  ! Arrays in physical space
  real(8), allocatable, dimension(:, :, :) :: ux, uy, uz
  real(8), allocatable, dimension(:, :, :) :: vortx, vorty, vortz
  real(8), allocatable, dimension(:, :, :) :: velvortx, velvorty, velvortz
  real(8), allocatable, dimension(:, :, :) :: uxg, uyg, uzg

  ! Arrays in spectral space
  !complex(C_DOUBLE_COMPLEX), allocatable, dimension(:, :, :) :: ux_hat, uy_hat, uz_hat
  !complex(C_DOUBLE_COMPLEX), allocatable, dimension(:, :, :) :: ux_hat2, uy_hat2, uz_hat2
  !complex(C_DOUBLE_COMPLEX), allocatable, dimension(:, :, :) :: vortx_hat, vorty_hat, vortz_hat
  !complex(C_DOUBLE_COMPLEX), allocatable, dimension(:, :, :) :: velvortx_hat, velvorty_hat, velvortz_hat
  !complex(C_DOUBLE_COMPLEX), allocatable, dimension(:, :, :) :: rhsx, rhsy, rhsz, rhsx0, rhsy0, rhsz0

  ! Wavenumber related arrays
  !real(8), allocatable, dimension(:, :, :) :: kx, ky, kz, k2, k2inv, kabs, ksqr
  !integer, allocatable, dimension(:, :, :) :: ik2
  real(8), parameter :: pi=3.1415927410125732
  real(8), parameter :: pi2=2*pi

  ! Kinematic viscosity
  real(8), parameter :: visc = 1/300.
  real(8) :: dx, dy, dz
  integer :: istep

  ! Number of timesteps
  integer, parameter :: nsteps=2000

  ! output to be written
  !integer, parameter :: ndump=50
  ! Output to ASCII files every ... steps
  !integer, parameter :: noutput=50
  ! \Delta t
  real(8), parameter :: dt=0.005

  !Spectral truncation 
  !real(8) :: klimit=n/3.


  ! Benchnark timing and counters
  real :: start, finish
  integer :: i, j, k
  
  
  dx=pi2/nx
  dy=pi2/ny
  dz=pi2/nz

  allocate(ux(nx, ny, nz))
  allocate(uy(nx, ny, nz))
  allocate(uz(nx, ny, nz))

  ! Initialize velocity field according to the Taylor-Green Vortex case

  call initial_condition(n, ux, uy, uz, vortx, vorty, vortz)

  do k=1, n
     do j=1, n
        do i=1, n
           ux(i,j,k) = sin((i-0.5)*dx)*cos((j-0.5)*dy)*cos((k-0.5)*dz)
           uy(i,j,k) = -cos((i-0.5)*dx)*sin((j-0.5)*dy)*cos((k-0.5)*dz)
           uz(i,j,k) = 0
           !vortx(i,j,k)=-cos((i-0.5)*dx)*sin((j-0.5)*dy)*cos((k-0.5)*dz)
           !vorty(i,j,k)=-sin((i-0.5)*dx)*cos((j-0.5)*dy)*sin((k-0.5)*dz)
           !vortz(i,j,k) = sin((i-0.5)*dx)*sin((j-0.5)*dy)*cos((k-0.5)*dz) //&
           !               -sin((i-0.5)*dx)*sin((j-0.5)*dy)*cos((k-0.5)*dz)
        enddo
     enddo
  enddo

  write(*, "(I7)") n
  
  !------------------------------------------------------------
  ! Main time loop
  !------------------------------------------------------------
  
  call cpu_time(start)
  
  do istep=1, nsteps
     if (mod(istep, 10)==0) then
        write(*,"(I7,1X,1pe14.6)") istep, istep*dt
     endif

  enddo ! timeloop

  deallocate(ux, uy, uz)

  
  call cpu_time(finish)
  write(*, "(1X, 1pe14.6)") finish - start

endprogram main

